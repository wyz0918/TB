define(function(require,exports,module){require("ace");var a={commit:"/course/codesubmit"},c=pageInfo.mid;c+="-"+Math.round(1e7*Math.random());var h="/course/savecode",g="http://codeweb.imooc.com/",v="http://cr.fw.imooc.com/run/viewresult?file=",_="http://csharp.imooc.com/run/viewresult?srcfile=",C=function(a){this.elems=a,this.editors=[],this.defaults=[],this.fileurl="",this.files=[],this.temp="",this.runNow=!0,this.wHeight=$(window).height(),this.wWidth=$(window).width(),this.initialization()};C.prototype={initialization:function(){var a=this;this.lastFile=null,$.each(a.elems,function(i,c){function t(){a.runNow&&a.runCode()}var h=ace.edit(c),g=$(c).attr("data-lang");("c"===g||"cpp"===g)&&(g="c_cpp"),("oc"===g||"oc_h"===g)&&(g="objectivec"),h.setTheme("ace/theme/tomorrow_night"),h.getSession().setMode("ace/mode/"+g),h.session.setUseWrapMode(!0),h.session.setWrapLimitRange(null,null),h.renderer.setShowPrintMargin(!1),h.setFontSize("14px"),h.lang=g,h.setHighlightActiveLine(!1),h.filename=$(c).attr("data-filename"),a.defaults.push(h.getValue());var v={filename:$(c).attr("data-filename"),lang:$(c).attr("data-lang"),content:h.getValue()};a.files.push(v),a.editors.push(h);var _;h.on("change",function(){v.content=h.getValue(),a.lastFile=v,_&&clearTimeout(_),_=setTimeout(t,500)})}),("html"==a.files[0].lang||"javascript"==a.files[0].lang)&&($(".aotorun").show(),a.runNow=!1),$("#aotoruncheck").on("click",function(){a.runNow=this.checked}),setTimeout(function(){a.showViewport()},100)},showViewport:function(){var a=$('<iframe name="Consoleframe" id="J_Console" frameborder="0" width="100%" height="100%"></iframe>');a.appendTo($("#viewPort-content"))},runCode:function(a,C){C&&(this.callback=C,this.isCommit=a);var w,J=this,j=function(a,c){var h,C=window.frames.Consoleframe;if(c)J.callback&&(J.callback(),J.callback=null),h=C.document?C.document:C.contentDocument,h.open(),h.write(a),h.close();else if(0===a.errno&&a.file){var w="";w="java"==a.cat?v:"csharp"==a.cat?_:"php"==a.cat?v:"python"==a.cat?v:"c"==a.cat?v:"cpp"==a.cat?v:"oc"==a.cat?v:"golang"==a.cat?v:g,J.fileurl=a.file,J.callback&&(J.callback(),J.callback=null),$("#J_Console").attr("src",w+a.file)}else{var j,k=$("#step-message");k.length||($(".editor-btn").after('<div id="step-message" class="step-message"><i class="icon-point" ></i><span></span></div>'),k=$("#step-message")),clearTimeout(j),k.find("span").text((a.msg||"")+"，再试试！"),k.is(":visible")||k.fadeIn(),j=setTimeout(function(){k.fadeOut("fast")},5e3)}};if("php"==J.files[0].lang&&1==J.files.length&&a){var k=J.files[0].filename;$.post(h,{lang:"php",cid:course_id,code:J.files[0].content,sid:c,filename:k},function(a){a&&a.result_type?$("#J_Console").attr("src","http://php.mukewang.com/"+c+"/"+k+"?rnd="+Math.random()):(a.cat="php",j(a))})}else if("python"==J.files[0].lang&&1==J.files.length&&a)$.post(h,{lang:"python",cid:course_id,code:J.files[0].content,sid:c,filename:J.files[0].filename},function(a){a.cat="python",j(a)});else if("golang"==J.files[0].lang&&1==J.files.length&&a)$.post(h,{lang:"golang",cid:course_id,code:J.files[0].content,sid:c,filename:J.files[0].filename},function(a){a.cat="golang",j(a)});else if("ruby"==J.files[0].lang&&1==J.files.length&&a)$.post(h,{lang:"ruby",cid:course_id,code:J.files[0].content,sid:c,filename:J.files[0].filename},function(a){j(a)});else if("sass"==J.files[0].lang&&1==J.files.length&&a)$.post(h,{lang:"sass",cid:course_id,code:J.files[0].content,sid:c,filename:J.files[0].filename},function(a){j(a)});else if("c"==J.files[0].lang&&1==J.files.length&&a)$.post(h,{lang:"c",cid:course_id,code:J.files[0].content,sid:c,filename:J.files[0].filename},function(a){a.cat="c",j(a)});else if("oc"==J.files[0].lang&&1==J.files.length&&a)$.post(h,{lang:"oc",cid:course_id,code:J.files[0].content,sid:c,filename:J.files[0].filename},function(a){a.cat="oc",j(a)});else if("oc"==J.files[0].lang&&J.files.length>1&&a){var y,I=0,b=J.files.length;$.each(J.files,function(i,a){$.post(h,{lang:"oc",cid:course_id,code:a.content,sid:c,filename:a.filename},function(a){I++,0==i&&(y=a),b===I&&y&&(y.cat="oc",j(y))})})}else if("cpp"==J.files[0].lang&&1==J.files.length&&a)$.post(h,{lang:"cpp",cid:course_id,code:J.files[0].content,sid:c,filename:J.files[0].filename},function(a){a.cat="cpp",j(a)});else if("c"==J.files[0].lang&&J.files.length>1&&a){var y,I=0,b=J.files.length;$.each(J.files,function(i,a){$.post(h,{lang:"c",cid:course_id,code:a.content,sid:c,filename:a.filename},function(a){I++,0==i&&(y=a),b===I&&y&&(y.cat="c",j(y))})})}else if("javascript"==J.files[0].lang&&1==J.files.length)$.post(h,{lang:"javascript",cid:course_id,code:J.files[0].content},function(a){j(a)});else if("php"==J.files[0].lang&&J.files.length>1){var T="",N=[],E=0;$.each(J.files,function(i,g){"php"==g.lang&&a?$.post(h,{lang:"php",cid:course_id,filename:g.filename,sid:c,code:g.content},function(a){if(N.push(a),E++,E==J.files.length)for(var i=0;i<N.length;i++)-1!=N[i].file.indexOf("index")&&$("#J_Console").attr("src",v+N[i].file)}):"javascript"==g.lang?T+="<script>	window.onerror=function(){return true;};try {"+g.content+'} catch(err) {　document.writeln("Error name: " + err.name)　document.writeln("Error message: " + err.message)}</script>':"css"==g.lang?T+="<style>"+g.content+"</style>":"python"==g.lang&&a&&$.post(h,{lang:"python",cid:course_id,code:g.content},function(a){T+=a.data,j(T)})})}else if("java"==J.files[0].lang&&1==J.files.length&&a)$.post(h,{lang:"java",cid:course_id,code:J.files[0].content,filename:J.files[0].filename,sid:c},function(a){a.cat="java",j(a)});else if("java"==J.files[0].lang&&J.files.length>1&&a)$.each(J.files,function(i,a){$.post(h,{lang:"java",cid:course_id,code:a.content,filename:a.filename,sid:c},function(a){a.cat="java",0==i&&j(a)})});else if("csharp"==J.files[0].lang&&1==J.files.length&&a)$.post(h,{lang:"csharp",cid:course_id,code:J.files[0].content,filename:J.files[0].filename,sid:c},function(a){a.cat="csharp",j(a)});else if("html"==J.files[0].lang&&2==J.files.length&&"php"===J.files[1].lang){var k=J.files[1].filename;J.lastFile&&"html"==J.lastFile.lang?j(J.files[0].content,1):a&&$.post(h,{lang:"php",cid:course_id,code:J.files[1].content,sid:c,filename:k},function(a){a&&a.result_type?$("#J_Console").attr("src","http://php.mukewang.com/"+c+"/"+k+"?rnd="+Math.random()):0===a.errno&&a.file&&j(J.files[0].content,1)})}else if("html"==J.files[0].lang){var M="<\\s*link[^>]*?href=(['\"])\\s*",S="\\s*\\1[^>]*?>",V="<\\s*script[^>]*?src=(['\"])\\s*",F="\\s*\\1[\\s\\S]*?<\\/script>";$.each(J.files,function(i,a){var c,h;"html"==a.lang?w=a.content:"css"==a.lang?(c=new RegExp(M+a.filename+S),c.test(w)&&(w=w.replace(c,"<style>"+a.content+"</style>"))):"javascript"==a.lang&&(h=new RegExp(V+a.filename+F),h.test(w)&&(w=w.replace(h,"<script>"+a.content+"</script>")))}),j(w,1)}else 1==J.files.length&&a&&$.post(h,{lang:J.files[0].lang,code:J.files[0].content,sid:c,filename:J.files[0].filename},function(a){j(a)})},_reset:function(){var a=this,c=$("#reset_mid").attr("rel"),h=$("#reset_step").attr("rel");$.ajax({type:"POST",url:"/course/resetcode",data:{mid:c,step:h},dataType:"json",success:function(c){if(0==c.result){for(var h={},g=c.data.length;g--;)h[c.data[g].filename]=c.data[g];$.each(a.editors,function(i,a){h[a.filename]&&a.setValue(h[a.filename].content)})}}})},commit:function(){function c(a){var c=$("#step-message");c.length||($(".editor-btn").after('<div id="step-message" class="step-message"><i class="icon-point" ></i><span></span></div>'),c=$("#step-message")),clearTimeout(v),c.find("span").text((a.msg||"")+"，再试试！"),c.is(":visible")||c.fadeIn(),v=setTimeout(function(){c.fadeOut("fast")},5e3)}var h=["提交正确。","敲的漂亮。","Wow，好厉害。","成功了，让编程来的更猛烈些吧。","不错，慕兄我看好你！","Nice，你这是年薪过百万的节奏啊！","God，你离成神已经不远了！","这你都能通过，无法直视你的双眸。","好，让我们继续一起愉快的玩耍吧。"],g=h.length;$("#J_EditorCommit").on("click","#J_Close,#J_CodeCancel",function(e){e.preventDefault(),$("#J_EditorCommit").animate({height:0},function(){$(this).html("").css({height:"",display:"none"})})});var v;return function(v,_){var C=this;this.runCode(1,function(){{var w={};C.files.length}w.cid=course_id,w.mid=pageInfo.mid,w.eid=pageInfo.eid,w.step=pageInfo.step,w.lang=v,w.file=C.fileurl,w.files=C.files,$.ajax({url:a.commit,type:"POST",dataType:"json",data:w,success:function(a){var v;return _&&_(a),pageInfo.stepTotal>1&&pageInfo.step<pageInfo.stepTotal?void(0===a.result||-201===a.result?window.location.href="/code/"+pageInfo.mid+"?step="+(pageInfo.step+1):c(a)):(pageInfo.stepTotal>1&&pageInfo.step===pageInfo.stepTotal&&(0===a.result||-201===a.result)&&$(".step-current").addClass("step-finished").removeClass("step-current").siblings(".task-finished-bar").css({width:"100%"}),-200===a.result?$("#J_EditorCommit").html(0==pageInfo.next_mid?'<p class="fail"><span class="status icon-point"></span>'+a.msg+' <a class="operate faColor" id="J_CodeCancel">再试试</a>! <a class="operate suColor" id="J_CodeNext" href="'+a.data.next+'"> 返回课程</a></p><a href="javascript:;" class="close  icon-close" id="J_Close"></a>':'<p class="fail"><span class="status icon-point"></span>'+a.msg+'，<a class="operate faColor" id="J_CodeCancel">再试试</a>！直接进入<a class="operate suColor" href="'+a.data.next+'">下一节</a></p><a href="javascript:;" class="close  icon-close" id="J_Close"></a>'):0===a.result?0==pageInfo.next_mid?$("#J_EditorCommit").html(pageInfo.isfinished?'<p class="success"><span class="status icon-tick2"></span> 恭喜你,通过了本次课程 <a class="operate suColor" id="J_CodeNext" href="'+a.data.next+'">返回课程</a></p><a href="javascript:;" class="close  icon-close" id="J_Close"></a>':'<p class="success"><span class="status icon-tick2"></span>代码提交成功，课程持续更新中，敬请期待！<a class="operate suColor" id="J_CodeNext" href="'+a.data.next+'">返回课程</a></p><a href="javascript:;" class="close  icon-close" id="J_Close"></a>'):(v="1"==$("#J_CodeLang").data("regular")?h[Math.floor(Math.random()*g)]:"该节编程练习不验证代码，你可以各种尝试，或继续学习",$("#J_EditorCommit").html('<p class="success"><span class="status icon-tick2"></span>'+v+'<a class="operate suColor" id="J_CodeNext" href="'+a.data.next+'">下一节</a>吧。</p><a href="javascript:;" class="close  icon-close" id="J_Close"></a>')):-201===a.result&&$("#J_EditorCommit").html(0==pageInfo.next_mid?pageInfo.isfinished?'<p class="success"><span class="status icon-tick2"></span> 恭喜你,通过了本次课程 <a class="operate suColor" id="J_CodeNext" href="'+a.data.next+'">返回课程</a></p><a href="javascript:;" class="close  icon-close" id="J_Close"></a>':'<p class="success"><span class="status icon-tick2"></span> 代码提交成功，课程持续更新中，敬请期待！ <a class="operate suColor" id="J_CodeNext" href="'+a.data.next+'">返回课程</a></p><a href="javascript:;" class="close  icon-close" id="J_Close"></a>':'<p class="success"><span class="status icon-tick2"></span>代码提交成功，进入 <a class="operate suColor" id="J_CodeNext" href="'+a.data.next+'">下一节</a>！</p><a href="javascript:;" class="close  icon-close" id="J_Close"></a>'),void $("#J_EditorCommit").fadeIn())}})})}}()},module.exports={init:function(a){return new C(a)}}});